<!DOCTYPE html>
<html>
	<head>
		<title>Resize RGBA data from a BMP image and post-manipulation</title>
		<script src="./resize.js"></script>
	</head>
	<body onload="onloadHandle();">
		<span id="wait">Please wait while the demo downloads html5_logo.bmp...</span>
		<canvas id ="test" width="500" height="500"></canvas>
		<script>
			var resizeObj = new Resize(1200, 1689, 500, 500, true);
			try {
				var framebuffer = new Int32Array(1689 * 1200 * 4);
			}
			catch (error) {
				var framebuffer = [];
			}
			function decodeBMP() {
				if (ajaxReq.readyState >= 4 && ajaxReq.responseText.length) {
					document.getElementById("wait").style.display = "none";
					var data = ajaxReq.responseText;
					var dataPos = data.length - 1689 * 1200 * 3;
					var yAdj = 1688 * 4800;
					for (var y = 0; yAdj >= 0; yAdj -= 4800) {
						for (var x = 0; x < 4800;) {
							framebuffer[yAdj + 2 + (x++)] = data.charCodeAt(dataPos++) & 0xFF;
							framebuffer[yAdj + (x++)] = data.charCodeAt(dataPos++) & 0xFF;
							framebuffer[yAdj - 2 + (x++)] = data.charCodeAt(dataPos++) & 0xFF;
							framebuffer[yAdj + (x++)] = 0xFF;
						}
					}
					framebuffer = resizeObj.resize(framebuffer);
					updateCanvas();
					setInterval(colorifyImage, 30);
				}
			}
			function updateCanvas() {
				var data = imageData.data;
				var length = data.length;
				for (var x = 0; x < length; ++x) {
					data[x] = framebuffer[x] & 0xFF;
				}
				contextHandle.putImageData(imageData, 0, 0);
			}
			function colorifyImage() {
				var length = framebuffer.length;
				for (var x = 0; x < length; x += 4) {
					if ((framebuffer[x] & framebuffer[x + 1] & framebuffer[x + 2]) >= 0xFC || framebuffer[x + 3] == 0xFE) {
						framebuffer[x] = Math.round(Math.random() * 0xFF);
						framebuffer[x + 1] = Math.round(Math.random() * 0xFF);
						framebuffer[x + 2] = Math.round(Math.random() * 0xFF);
						framebuffer[x + 3] = 0xFE;
					}
				}
				updateCanvas();
			}
			function onloadHandle() {
				ajaxReq = new XMLHttpRequest();
				ajaxReq.onreadystatechange = decodeBMP;
				ajaxReq.open("GET", "./html5_logo.bmp", true);
				ajaxReq.setRequestHeader("Content-Type", "application/octet-stream");
				try {
					ajaxReq.overrideMimeType('text/plain; charset=x-user-defined'); 
				}
				catch (error) {
					//No support...
				}
				ajaxReq.send();
				canvasHandle = document.getElementById("test");
				contextHandle = canvasHandle.getContext("2d");
				imageData = contextHandle.getImageData(0, 0, 500, 500);
			}
		</script>
	</body>
</html>